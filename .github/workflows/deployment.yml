name: Deploy to Self-Hosted Windows Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: timeflow
  CONTAINER_NAME: timeflow-web
  APP_PORT: 5173

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set build metadata
        shell: powershell
        run: |
          $SHORT_SHA = "${{ github.sha }}".Substring(0, 7)
          $BUILD_DATE = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          "SHORT_SHA=$SHORT_SHA" | Out-File $env:GITHUB_ENV -Append
          "BUILD_DATE=$BUILD_DATE" | Out-File $env:GITHUB_ENV -Append
          "FULL_IMAGE=$env:DOCKERHUB_USERNAME/${{ env.IMAGE_NAME }}:$SHORT_SHA" | Out-File $env:GITHUB_ENV -Append
          "LATEST_IMAGE=$env:DOCKERHUB_USERNAME/${{ env.IMAGE_NAME }}:latest" | Out-File $env:GITHUB_ENV -Append

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create runtime .env file
        shell: powershell
        run: |
          # Create .env for local reference only (not used in container)
          @(
            "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}",
            "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}",
            "VITE_BASE_PATH=/",
            "GIT_COMMIT=${{ env.SHORT_SHA }}",
            "BUILD_DATE=${{ env.BUILD_DATE }}"
          ) | Set-Content .env -Encoding utf8
          Write-Host "Environment file created for reference"

      - name: Stop existing container (if any)
        shell: powershell
        run: |
          if (docker ps -a --format "{{.Names}}" | Select-String "^${{ env.CONTAINER_NAME }}$") {
            docker stop ${{ env.CONTAINER_NAME }} | Out-Null
            docker rm ${{ env.CONTAINER_NAME }} | Out-Null
          }

      - name: Build Docker image
        shell: powershell
        run: |
          docker build `
            -f timeflow/Dockerfile `
            --build-arg NEXT_PUBLIC_SUPABASE_URL="${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" `
            --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" `
            --build-arg VITE_BASE_PATH="/" `
            --build-arg GIT_COMMIT="${{ env.SHORT_SHA }}" `
            --build-arg BUILD_DATE="${{ env.BUILD_DATE }}" `
            -t $env:FULL_IMAGE `
            -t $env:LATEST_IMAGE `
            .

      - name: Push Docker image
        shell: powershell
        run: |
          docker push $env:FULL_IMAGE
          docker push $env:LATEST_IMAGE

      - name: Run container
        shell: powershell
        run: |
          docker run -d `
            --name $env:CONTAINER_NAME `
            --restart unless-stopped `
            -p ${{ env.APP_PORT }}:80 `
            $env:LATEST_IMAGE

      - name: Verify container is running
        shell: powershell
        run: |
          Start-Sleep 3
          $containerStatus = docker ps --filter "name=$env:CONTAINER_NAME" --format "{{.Status}}"
          Write-Host "Container status: $containerStatus"
          
          if (-not $containerStatus) {
            Write-Error "Container is not running!"
            docker logs $env:CONTAINER_NAME --tail 100
            exit 1
          }

      - name: Show container logs
        shell: powershell
        run: |
          Write-Host "=== Container Logs ==="
          docker logs $env:CONTAINER_NAME --tail 50

      - name: Health check
        shell: powershell
        run: |
          Write-Host "Starting health check on http://localhost:${{ env.APP_PORT }}/health"
          
          for ($i = 1; $i -le 30; $i++) {
            Write-Host "Attempt $i of 30..."
            try {
              $response = Invoke-WebRequest "http://localhost:${{ env.APP_PORT }}/health" -TimeoutSec 5 -UseBasicParsing
              Write-Host "Application is healthy! Status: $($response.StatusCode)"
              exit 0
            } catch {
              Write-Host "Health check failed: $_"
              if ($i -eq 30) {
                Write-Host ""
                Write-Host "=== Final Container Logs ==="
                docker logs $env:CONTAINER_NAME --tail 100
                Write-Host ""
                Write-Host "=== Container Inspect ==="
                docker inspect $env:CONTAINER_NAME
                Write-Error "Application failed health check after 30 attempts"
                exit 1
              }
              Start-Sleep 5
            }
          }

      - name: Cleanup
        if: always()
        shell: powershell
        run: |
          Remove-Item .env -ErrorAction SilentlyContinue
          docker logout
          docker system prune -f