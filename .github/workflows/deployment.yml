name: Deploy to Self-Hosted Windows Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: timeflow
  CONTAINER_NAME: timeflow-web
  APP_PORT: 5173

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Git commit info
        run: |
          $SHORT_SHA = "${{ github.sha }}".Substring(0, 7)
          $BRANCH = "${{ github.ref_name }}"
          $BUILD_DATE = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          $AUTHOR = "${{ github.actor }}"

          "SHORT_SHA=$SHORT_SHA" | Out-File $env:GITHUB_ENV -Append
          "BRANCH=$BRANCH" | Out-File $env:GITHUB_ENV -Append
          "BUILD_DATE=$BUILD_DATE" | Out-File $env:GITHUB_ENV -Append
          "AUTHOR=$AUTHOR" | Out-File $env:GITHUB_ENV -Append
          "FULL_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:$SHORT_SHA" | Out-File $env:GITHUB_ENV -Append
          "LATEST_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest" | Out-File $env:GITHUB_ENV -Append

      - name: DockerHub Login
        run: |
          docker logout
          "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Create .env file
        run: |
          $envContent = @(
            "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}",
            "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}",
            "VITE_BASE_PATH=/",
            "GIT_COMMIT=${{ env.SHORT_SHA }}",
            "BUILD_DATE=${{ env.BUILD_DATE }}"
          )

          Set-Content -Path .env -Value $envContent -Encoding utf8

      - name: Stop existing container
        run: |
          if (docker ps -a --format "{{.Names}}" | Select-String "^${{ env.CONTAINER_NAME }}$") {
            docker stop ${{ env.CONTAINER_NAME }}
            docker rm ${{ env.CONTAINER_NAME }}
          }

      - name: Remove old images
        run: |
          docker rmi ${{ env.FULL_IMAGE }} -f 2>$null
          docker rmi ${{ env.LATEST_IMAGE }} -f 2>$null

      - name: Build image
        run: |
          docker compose -f timeflow/docker-compose.yml build --no-cache

      - name: Push images
        run: |
          docker push ${{ env.FULL_IMAGE }}
          docker push ${{ env.LATEST_IMAGE }}

      - name: Deploy container
        run: |
          docker compose -f timeflow/docker-compose.yml up -d

      - name: Health check
        run: |
          $tries = 20
          for ($i = 1; $i -le $tries; $i++) {
            try {
              Invoke-WebRequest http://localhost:${{ env.APP_PORT }} -TimeoutSec 5 | Out-Null
              exit 0
            } catch {
              Start-Sleep 5
            }
          }
          docker logs ${{ env.CONTAINER_NAME }} --tail 100
          exit 1

      - name: Cleanup
        if: always()
        run: |
          Remove-Item .env -ErrorAction SilentlyContinue
          docker system prune -f
          docker logout
