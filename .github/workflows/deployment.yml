name: Deploy to Self-Hosted Windows Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: timeflow
  CONTAINER_NAME: timeflow-web
  APP_PORT: 5173

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set build metadata
        shell: powershell
        run: |
          $SHORT_SHA = "${{ github.sha }}".Substring(0, 7)
          $BUILD_DATE = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          "SHORT_SHA=$SHORT_SHA" | Out-File $env:GITHUB_ENV -Append
          "BUILD_DATE=$BUILD_DATE" | Out-File $env:GITHUB_ENV -Append
          "FULL_IMAGE=$env:DOCKERHUB_USERNAME/${{ env.IMAGE_NAME }}:$SHORT_SHA" | Out-File $env:GITHUB_ENV -Append
          "LATEST_IMAGE=$env:DOCKERHUB_USERNAME/${{ env.IMAGE_NAME }}:latest" | Out-File $env:GITHUB_ENV -Append

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create runtime .env file
        shell: powershell
        run: |
          @(
            "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}",
            "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}",
            "VITE_BASE_PATH=/",
            "GIT_COMMIT=${{ env.SHORT_SHA }}",
            "BUILD_DATE=${{ env.BUILD_DATE }}"
          ) | Set-Content .env -Encoding utf8

      - name: Stop existing container (if any)
        shell: powershell
        run: |
          if (docker ps -a --format "{{.Names}}" | Select-String "^${{ env.CONTAINER_NAME }}$") {
            docker stop ${{ env.CONTAINER_NAME }} | Out-Null
            docker rm ${{ env.CONTAINER_NAME }} | Out-Null
          }

      - name: Build Docker image
        shell: powershell
        run: |
          docker build `
            -f timeflow/Dockerfile `
            -t $env:FULL_IMAGE `
            -t $env:LATEST_IMAGE `
            .

      - name: Push Docker image
        shell: powershell
        run: |
          docker push $env:FULL_IMAGE
          docker push $env:LATEST_IMAGE

      - name: Run container
        shell: powershell
        run: |
          docker run -d `
            --name $env:CONTAINER_NAME `
            --restart unless-stopped `
            -p ${{ env.APP_PORT }}:${{ env.APP_PORT }} `
            --env-file .env `
            $env:LATEST_IMAGE

      - name: Health check
        shell: powershell
        run: |
          for ($i = 1; $i -le 20; $i++) {
            try {
              Invoke-WebRequest "http://localhost:${{ env.APP_PORT }}" -TimeoutSec 5 | Out-Null
              Write-Host "Application is healthy"
              exit 0
            } catch {
              Start-Sleep 5
            }
          }

          Write-Error "Application failed health check"
          docker logs $env:CONTAINER_NAME --tail 100
          exit 1

      - name: Cleanup
        if: always()
        shell: powershell
        run: |
          Remove-Item .env -ErrorAction SilentlyContinue
          docker logout
          docker system prune -f